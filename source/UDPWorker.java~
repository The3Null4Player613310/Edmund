import java.net.*;
import java.io.*;

public class UDPWorker implements Runnable
{
    //DatagramSocket socket;
    MulticastSocket socket;
    DatagramPacket packetIn;
    DatagramPacket packetOut;
    InetAddress group;

    public UDPWorker()
    {
    }

    public void run()
    {
        try
        {
            //socket = new DatagramSocket(Server.DEFAULT_PORT_UDP);
            socket = new MulticastSocket(Server.DEFAULT_PORT_UDP);
            group = InetAddress.getByName("225.252.64.32");
            socket.joinGroup(group);
            packetIn = new DatagramPacket (new byte[1024], 1024);
        }
        catch( Exception ex)
        {
            System.out.println("Problem creating socket on port: " + Server.DEFAULT_PORT_UDP);
            ex.printStackTrace();
            Server.isRunning = false;
        }

        while(Server.isRunning)
        {
            try
            {
                socket.receive(packetIn);
                //System.out.println(packetIn.getOffset() + ":" + packetIn.getLength()); //Debug
                String msg = new String(packetIn.getData(), packetIn.getOffset(), packetIn.getLength());
                System.out.println("Received from: " + packetIn.getAddress() + ":" + packetIn.getPort() + "\n" + msg);
                packetOut = new DatagramPacket ( msg.getBytes(), msg.getBytes().length, packetIn.getAddress(), Server.DEFAULT_PORT_UDP); 
                socket.send(packetOut);
            }
            catch(IOException ie)
            {
                ie.printStackTrace();
                Server.isRunning = false;
            }
        }

        //close socket here
        try
        {
            socket.close();
        }
        catch(Exception ex)
        {
            ex.printStackTrace();
        }
    }
}